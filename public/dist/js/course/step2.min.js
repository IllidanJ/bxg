define(["jquery","template","tools","uploadify","jquery_Jcrop"],function(t,e,i){t(function(){var o=i.getId();t.ajax({url:"/api/course/picture",type:"get",data:{cs_id:o},success:function(i){if(200==i.code){var c=e("picture",i.result);t(".body").html(c),t("#file_upload").uploadify({height:30,swf:"/public/assets/uploadify/uploadify.swf",uploader:"/api/uploader/cover",width:70,buttonClass:"btn btn-success btn-sm",buttonText:"上传图片",fileObjName:"cs_cover_original",formData:{cs_id:i.result.cs_id},onInit:function(){t("#file_upload-button").removeAttr("style").css({height:"30px",width:"70px"}).find(".uploadify-button-text").css({lineHeight:"1.5"})},onUploadSuccess:function(e,i,o){n=JSON.parse(i).result.path,t(".preview img").attr("src",n),a&&a.setImage(n),t(".brief img").attr("src",n).show(),t("#preview").hide()}});var a,s,n=i.result.cs_cover_original;t("#pic").Jcrop({aspectRatio:2,boxWidth:400},function(){a=this}),t(".body").on("click","#jcrop",function(){if(a&&"裁切图片"==t(this).html()){t(this).html("保存图片"),t(".thumb img").hide(),t(".thumb").append('<canvas height="120px" width="240px" id="preview"></canvas>');var e=document.querySelector("#preview"),i=e.getContext("2d"),c=new Image;c.src=n,a.newSelection(),a.setSelect([10,10,1e3,1e3]),a.setOptions({onChange:function(){s={cs_id:o,x:a.getSelection().x/400*c.naturalWidth,y:a.getSelection().y/400*c.naturalWidth,w:a.getSelection().w/400*c.naturalWidth,h:a.getSelection().h/400*c.naturalWidth},console.log(s),t(".thumb img").hide(),t("#preview").show(),c.src=n,i.beginPath(),i.clearRect(0,0,e.width,e.height),i.drawImage(c,s.x,s.y,s.w,s.h,0,0,e.width,e.height)}})}else"保存图片"==t(this).html()&&t.ajax({type:"post",url:"/api/course/update/picture",data:s,success:function(t){location.href="/course/step3?cs_id="+o}})})}}})})});